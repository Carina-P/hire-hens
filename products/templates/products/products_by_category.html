{% extends "base_products.html" %}
{% load static %}
{% load cart_tools %}

{% block products_header %}
{{ this_category }}
{% endblock products_header %}

{% block products_content %}
<div class="row p-3">
    {% for product in products %}
    <div class="col-sm-6 col-md-6 col-lg-4 col-xl-3">
        {% include 'includes/card.html' %}
    </div>
    {% if forloop.counter|divisibleby:1 %}
    <div class="col-12 d-sm-none mb-2">
        <hr>
    </div>
    {% endif %}
    {% if forloop.counter|divisibleby:2 %}
    <div class="col-12 d-none d-sm-block d-md-block d-lg-none mb-2">
        <hr>
    </div>
    {% endif %}
    {% if forloop.counter|divisibleby:3 %}
    <div class="col-12 d-none d-lg-block d-xl-none mb-2">
        <hr>
    </div>
    {% endif %}
    {% if forloop.counter|divisibleby:4 %}
    <div class="col-12 d-none d-xl-block mb-2">
        <hr>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% if rent == True %}
<div class="row mb-3">
    <div class="col bg-white border-black pt-4">
        {% if package_items %}
        <h4 class="text-center pb-3">MY RENTAL PACKAGE:</h4>
        <div class="table-responsive rounded">
            <table class="table table-sm text-center">
                <thead class="text-black">
                    <tr>
                        <h4>
                            <th scope="col">Product</th>
                            <th scope="col">Category</th>
                            <th scope="col">Price/Month</th>
                            <th scope="col">Qty</th>
                            <th scope="col">Subtotal/Month</th>
                        </h4>
                    </tr>
                </thead>
                {% for item in package_items %}
                <tr>
                    <td class="py-3">
                        <p class="my-0">{{ item.product.name }}</p>
                    </td>
                    <td class="p-3">
                        <p class="my-0">{{ item.category }}</p>
                    </td>
                    <td class="py-3">
                        <p class="my-0">{{ item.product.rental_price }} SEK</p>
                    </td>
                    <td class="py-3 w-25">
                        <!-- Code from Code institute -->
                        <form class="form update-package-form" method="POST"
                            action="{% url 'adjust_package' item.item_id  %}">
                            {% csrf_token %}
                            <div class=" form-group">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <button class="decrement-qty btn btn-sm btn-black"
                                            data-item_id="{{ item.item_id }}"
                                            id="decrement-package-qty_{{ item.item_id }}">
                                            <span>
                                                <i class="fas fa-minus fa-sm"></i>
                                            </span>
                                        </button>
                                    </div>
                                    <input class="form-control form-control-sm qty_input" type="number" name="quantity"
                                        value="{{ item.quantity }}" min="1" max="40" data-item_id="{{ item.item_id }}"
                                        id="id-package_qty_{{ item.item_id }}">
                                    <div class="input-group-append">
                                        <button class="increment-qty btn btn-sm btn-black"
                                            data-item_id="{{ item.item_id }}"
                                            id="increment_package-qty_{{ item.item_id }}">
                                            <span>
                                                <i class="fas fa-plus fa-sm"></i>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <a class="update-package-link text-info px-3"><small>Update</small></a>
                        <a class="remove-package-item text-danger"
                            id="remove-package_{{ item.item_id }}"><small>Remove</small></a>
                    </td>
                    <td class="py-3">
                        <p class="my-0">{{ item.product.rental_price | calc_subtotal:item.quantity }} SEK</p>
                    </td>
                </tr>
                {% endfor %}

                <tr>
                    <td colspan="5" class="pt-5 text-end">
                        <p></p><strong> Total/Month: {{ package_total|floatformat:2 }} SEK</strong></p>
                    </td>
                </tr>
                <tr>
                    <td colspan="5" class="text-center">
                        <form id="rent_form" class="form" action="{% url 'add_to_cart_rental' %}" method="POST">
                            {% csrf_token %}
                            <div class="form-row justify-contents-center">
                                <div class="col-4">
                                    <p class="mt-3"><strong>No of Rental Months</strong></p>
                                    <div class="form-group w-50 text-center">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <button class="decrement-qty btn btn-black" data-item_id='package'
                                                    id="decrement-qty">
                                                    <span class="icon">
                                                        <i class="fas fa-minus"></i>
                                                    </span>
                                                </button>
                                            </div>
                                            <input class="form-control qty_input" type="number" name="months" value="1"
                                                min="1" max="40" data-item_id="package" id="id_qty">
                                            <div class="input-group-append">
                                                <button class="increment-qty btn btn-black" data-item_id="package"
                                                    id="increment-qty">
                                                    <span class="icon">
                                                        <i class="fas fa-plus"></i>
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <button type="submit" class="btn btn-black btn-lg m-4">
                                        <span>ADD PACKAGE TO CART</span>
                                        <span class="icon">
                                            <i class="fas fa-shopping-cart"></i>
                                        </span>
                                    </button>
                                </div>
                                <input type="hidden" name="redirect_url" value="{{ request.path }}">
                            </div>
                        </form>
                    </td>
                </tr>

            </table>
        </div>
        {% else %}
        <p class="lead my-5 text-center">Nothing added to rental package.</p>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock products_content %}

{% block postloadjs %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/change_package_qty.js' %}"></script>

<script type="text/javascript">
    // Update quantity on click
    $('.update-package-link').click(function (e) {
        let form = $(this).prev('.update-package-form');
        form.submit();
    })

    // Remove item and reload on click
    $('.remove-package-item').click(function (e) {
        let csrfToken = "{{ csrf_token }}";
        let itemId = $(this).attr('id').split('remove-package_')[1];
        let url = `/products/remove_from_package/${itemId}/`;
        let data = {
            'csrfmiddlewaretoken': csrfToken
        };

        $.post(url, data)
            .done(function () {
                location.reload();
            });
    })
</script>

{% endblock %}